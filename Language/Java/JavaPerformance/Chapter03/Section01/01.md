# 1 CPUの使用率

* CPUの使用率とJavaプログラムにとっての意味

* CPUの使用率は`ユーザー時間`と`システム時間`の２つに分類できる
  * Windowsではシステム時間を`特権時間(privileged time)`

* ユーザ時間
  * CPUがアプリケーションのコードを実行している時間の割合を表す

* システム時間
  * CPUがOSのカーネルのコードを実行している時間の割合を表す
  * アプリケーションと無関係ではない
    * アプリケーションが入出力を行った場合、以下のコードを実行する
      * カーネルはファイルをディスクから読み出す
      * バッファーに保持されているデータをネットワークに送り込む
      * etc
    * システムリソースを使うプログラムで、システム時間はより長くなる

* ここで目標は、CPUの使用率を`できるだけ高く`し、その期間を`できるだけ短くすること`
  * CPU使用率100%の状態が`長く続いてしまえば`他のプログラムが実行されるのを
  妨げてしまうことになる
  * CPUの本当の意味について検討する

* CPU使用率の値は`ある一定の期間の平均値`を表しているという点
  * この期間はあいまいで、１秒以上、あるいは３０秒

  * 例）あるプログラムの実行に１０分かかり、その間のCPU使用率が５０％だった
    * １００％にあげるようなチューニングを行えたら、パフォーマンスは２倍になり、５分で実行できる
    * さらにパフォーマンスを２倍にできたとしたら、CPU使用率は１００％のままで実行時間は２分３０秒ということになる
  * CPU使用率とは、`プログラムがどの程度効率的にCPUを使えているか`ということを表す

* `vmstat`
  * [Linux]メモリーやCPUの負荷率や使用状況を表示する
  ``` cmd
  vmstat （オプション）［時間間隔 ［回数］］
  ```
  ``` cmd
  メモリーやCPUの情報を10秒間隔で3回表示する
  $ vmstat 10 3 
  procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------
   r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
   0  0     92   6608   6796 192804    0    0   126    23  548  569  9  1 89  2  0
   0  0     92   5764   6828 192836    0    0     0     8 1090 1576  2  0 98  0  0
   1  0     92   7092   6844 191284    0    0     0    77 1085 1510  1  0 98  0  0
  ```
  * cpu: CPUの使用量の割合
    * us(user): ユーザ時間の割合
    * sy(system): システム時間の割合
    * id(idle): アイドル時間（CPUが何も処理せずに待っていた時間）の割合 ※I/O待ちは含まない
    * wa(wait): IO待ち時間の割合
    * st(stolen): 仮想マシンに与えた時間の割合
  * 上記例の場合、10秒間の内何割かを表示する
    * 10000(msec) * 0.89 = 8900(msec)がアイドル時間
    * 10000 - 8900 = 1100(msec)がビジー状態
    * アイドルが0%なら、CPU使用率は100%

* アイドル状態はどういった状態か
  * アプリケーションにとって行うべき処理がない
  * アプリケーションが何か（例えばデータベースのレスポンス）を待っている
  * 同期プリミティブ（基本機構）でアプリケーションがブロックされ、ロックの解放まで実行が中断されている


## 参考

* [CPU使用率100%は悪なのか？](https://qiita.com/zd6ir7/items/2cb39f55f3b15af79f6f)