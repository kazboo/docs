# 4. 外部を見渡す(データベースは常にボトルネック)

* 外部のリソースを使わない、スタンドアロンなJavaアプリケーション
  * パフォーマンスにとって重要なのは、ほぼそのアプリケーション自身だけ

* データベースなどの外部リソースが関与する場合
  * アプリケーションだけでなく、リソースについてもパフォーマンスを考慮する必要が出てくる
  * 分散環境において...
    * リソース
      * データベース
      * JavaEEのアプリケーションサーバー
      * ロードバランサー
      * バックエンドのエンタープライズシステム
    * このような環境では
      * アプリケーションサーバーはあまり大きな問題にならないかもしれない
      * システムのすべての構成要素について、CPUの使用率や入出力の遅延、スループットを測定し分析する必要あり
        * そのコンポーネントがパフォーマンスにとってのボトルネックなのかわかる

* 本書ではJavaのコンポーネントに改善が必要な状況での解説を行う

* 初期分析も軽視してはいけない
  * データベースがボトルネックなら、データベースにアクセスするJavaのコードをいくらチューニングしても効果はない
  * 無益なチューニングは生産性の妨げになる

* 効率化のためにJavaアプリケーションを修正 > データベースへの負荷がさらに増えた
  * 原則
    * パフォーマンスの悪いコンポーネントへのアクセスを増やすと、システム全体としての速度が低下する
  * 全体のパフォーマンスは落ちることになる
  * しかし結果だけをみてこの修正が悪いものと結論付けるのは危険
    * データベースだけではなく様々なシナリオで原則は当てはまる
      * CPUがボトルネックになるアプリケーションサーバー
      * スレッドが保持しているロックを獲得しようとする別スレッドの増加

## バグやパフォーマンスはJVMだけの問題ではない

* 新バージョンのアプリケーションサーバーをインストールした
  * 徐々にサーバーへのリクエスト処理が徐々に遅くなっていくというテスト結果が得られた
    * プロファイリングを行ったところ、テスト用のApache Jmeterがパフォーマンス悪化の原因だった(テストコード)

* 環境内のあらゆるコンポーネントを検討するという心構えが必要