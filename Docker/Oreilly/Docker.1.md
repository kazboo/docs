# Docker 1

## Dockerとはなにか、なぜ注目されているか

* コンテナとは
  * アプリケーションを依存対象とともにカプセル化したもの
  * VM同様、隔離されたOS環境の中で、アプリケーションを動かす

* VMでは実現が難しい or 不可能なユースケースを可能とする利点がある
  * ホストOSとリソースを共有するため、はるかに効率的
  * コンテナの起動/停止は一瞬ｓ
  * コンテナ内で動くアプリケーションのオーバーヘッドはホストOS上と比較しても極僅か
  * コンテナのポータビリティ(可搬性)には動作環境のわずかな違いによるバグを撲滅できる可能性がある
  * コンテナは軽量なので数十のコンテナを同時に実行できる
    * VMだけを使う場合に比べ、1台のホストマシンではるかに多くのコンテナを実行できる
  * エンドユーザーは容易に複雑なアプリケーションをダウンロードして実行できる
    * アプリケーションの開発者はユーザーの環境や利用可能な依存対象の差異を心配せずに済むようになる

* VMとコンテナのゴール
  * VM: 異なる「環境」を完全にエミュレートすること
  * コンテナ:「アプリケーション」をポータブルにし、単体で動作できるようにすること

### VMとコンテナ

どちらもアプリケーションを同一ホスト上のほかのアプリケーションから隔離するために利用できる

* VM
  * VMを作成して動作させるためにはハイパーバイザー(※1)が必要
    * OS、アプリケーション、必要な支援ライブラリの完全コピーが必要
  * ハイパーバイザのおかげで隔離の度合いが高く、実績による信頼度も高い

* コンテナ
  * VMと異なりホストのカーネル(※2)は実行されるコンテナと共有される
    * 常にホストと同じカーネルを実行しなければならない
  * ハイパーバイザの実行に伴うオーバーヘッドがない
    * コンテナ内で実行しているプロセスはホスト上で直接動作するプロセスと同等
  * 実績がVMと比較すると浅く、VM内でコンテナを実行するハイブリッド型が広くみられる


単一のホスト上で動作している3つのVM
```
 VM1        VM2        VM3
---------- ---------- ----------
|app     | |app     | |app     |
---------- ---------- ----------
|lib     | |lib     | |lib     |
---------- ---------- ----------
|Guest OS| |Guest OS| |Guest OS|
--------------------------------
|Hyper Visor                   |
--------------------------------
|Host OS                       |
--------------------------------
|Hard Ware                     |
--------------------------------
```
単一のホスト上で動作している3つのコンテナ
```
 Co1        Co2        Co3
---------- ---------- ----------
|app     | |app     | |app     |
---------- ---------- ----------
|lib     | |lib     | |lib     |
--------------------------------
|Container Engine              |
--------------------------------
|Host OS                       |
--------------------------------
|Hard Ware                     |
--------------------------------
```

※1 タイプ2のハイパーバイザを指す(VirtualBox, VMWare)  
※2 カーネルはOSの核となる構成要素で、メモリ、CPU、デバイスアクセスに関連する、システムに必須な機能をアプリケーションに提供する

## Dockerとコンテナ

* UNIXのシステムのchrootコマンド
  * シンプルな形態のファイルシステムの隔離機能

* jail(1998年~)
  * chrootのサンドボックスをプロセスにまで拡張したもの

* Solaris Zones(2001年頃)
  * 比較的完全なコンテナ化の技術だったがSolaris OSでしか使えない

* Virtuozzo(2001年頃)
  * Parallels IncがLinux用にリリースした商用コンテナ技術

* OpenVZ(2005年)
  * Virtuozzoの中核技術をオープンソース化したもの
  * 広く使われることはなかった

* CGroups[Control Groups]
  * プロセスグループのリソース(CPU、メモリ、ディスクI/Oなど)の利用を制限・隔離するLinuxカーネルの機能
  * GoogleがLinuxカーネル用に開発し、自社のインフラのコンテナ移行を開始する

* Linux Containers(LXC) プロジェクト(2008年)
  * CGroups, カーネルネームスペース, chroot等の技術をまとめて完全なコンテナ化のソリューションの提供へと進み始めた

* Docker(2013年)
  * 既存のコンテナ技術をラップして拡張した
  * コンテナの生成/配布の完全なソリューションを生み出す

* Dockerというプラットフォームには2つの構成要素がある
  * Dockerエンジン
  * Docker Hub

* Dockerエンジン
  * コンテナの生成/実行を受け持つ
  * 動作中のコンテナへの高速で便利なインターフェイスを提供する

* Docker Hub
  * コンテナを配布するためのクラウドサービス
  * 公開イメージをダウンロードし、すぐに作業を開始できる

* Docker社が開発したツール
  * Swarm
    * クラスタマネージャ
  * Kitematic
    * コンテナを扱うGUI
  * Machine
    * DockerのホストをプロビジョニングするためのCLユーティリティ

* Open Container Initiative設立(2015年)
  * スポンサー：Docker, MS, CoreOS, etc
  * 標準を開発することをミッションとする

* Dockerコンテナのポータビリティと隔離
  * ほかの開発者や運用担当者との共同作業が容易になる
  * 開発者は自分のコードが様々な環境で動作することを確実に
  * 運用担当者はコンテナのホストとオーケストレーションに集中でき、コンテナ内で動作するコードについて心配する必要がなくなる

* 2018/10/12記事引用 - [なぜDockerではホストOSと違うOSベースのコンテナイメージが動くのか](https://qiita.com/kirikunix/items/33414240b4cacee362da?utm_source=Qiita%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9&utm_campaign=78de5bac45-Qiita_newsletter_334_10_24_2018&utm_medium=email&utm_term=0_e44feaa081-78de5bac45-33550453)
  * `Linuxサーバであればdockerコンテナはどこでも動く` ような印象を持つが、Linuxカーネルの互換性に依存しているため、文字通り `どこでも動くわけではない`
  * 新しいLinuxカーネルにのみ存在する機能を利用しているアプリケーションは、古いLinuxカーネル上では動作できない
  * コンテナが `仮想サーバのようにOSを再現する` ようなイメージを持ちがちだが、OS機能はホストOSに依存しており、`アプリケーションの動作を再現しているだけ` というイメージを持つことが重要