# ネットワーク

## 1. ネットワークの基礎

### プロトコル

* プロトコル
  * 通信を行う際に、事前に取り決めるルール
  * 例:日常会話
    * 媒体：空気
    * データリンク：音声
    * プレゼンテーション：日本語

* 通信における最重要概念

* 通信
  * データの送受信を行うこと

### OSI(Open System Interconnection)基本参照モデル

* OSI(基本)参照モデル
  * ISOが作ったデータ通信機能におけるモデル
  * 制定された目的
    * `異なる設計思想や世代のシステムと円滑に通信を行うこと`
  * プロトコルを標準化するにあたりどう作成すればよいのかガイドラインを示す
  * プロトコルの階層化を強く推奨している
    * メリット2つ
      * シンプルである
        * 通信プロトコルをシンプルにまとめることができる
        * １つの機能を小さく絞り込むことで安定した通信プログラムを開発できる
          * プロトコルスイート(プロトコルスタック)
          　* 目的の通信をするために必要な通信プロトコルをひと纏めにしたもの
      * 交換が容易である
        * プロトコルが更新された箇所だけを交換することが可能

* オープンシステム
  * どんな機器をつかっても仕様に沿っていれば接続できるようになっている仕組みのこと

* 7階層モデルと対応機器の例
  * 通信全体の機能を7分割している
  * 1-4を下位層、5-7を上位層
    * 下位層は通信そのものを制御する
    * 上位層は通信でやり取りされるデータの形などを規定する

|||対応機種|補足|
|:--|:--|:--|:--|:--|
|第7層(Layer7:L7)|アプリケーション層|ゲートウェイ|アプリケーションの世界|
|第6層(Layer6:L6)|プレゼンテーション層|||
|第5層(Layer5:L5)|セッション層|||
|第4層(Layer4:L4)|トランスポート層||トランスポートの世界(TCP/UDP)|
|第3層(Layer3:L3)|ネットワーク層|ルータ、L3スイッチ|IPパケットの世界(IP)|
|第2層(Layer2:L2)|データリンク層|ブリッジ、スイッチングハブ|イーサネットのフレームの世界(MAC), 宛先のみで、IPアドレスや中身を気にしない|
|第1層(Layer1:L1)|物理層|リピータ、ハブ|光、電流(信号)|

* 仮に下位層から上位層まで１つのプロトコルで開発された場合
  * プロトコルが更新されると、それに合わせてシステムのすべての箇所を変更する必要が生じる

### OSI参照モデルの詳細

#### 物理層(第１層)

* システムの物理的、電気的な性質を規定
  * デジタルデータをどのように電流の波形、電圧的な高低に割り付けるのか
  * ケーブルが満たすべき抵抗
  * コネクタピンの形状
  * etc

#### データリンク層(第２層)

* `同じネットワーク`に接続された隣接ノード間での通信について規定

* ブロードキャスト
  * 同じネットワークで接続されているすべてのノードにデータを送達する
  * その範囲を`ブロードキャストドメイン`と呼ぶ
  * MACアドレスの管理も行う

``` cmd
IPアドレスで到達できる範囲
<----------------------------------------------->
[PC]--同じネットワーク--[PC]--同じネットワーク--[PC]
<---------------------->|<---------------------->
MACで到達できる範囲
```

#### ネットワーク層(第３層)

* エンドtoエンド（ある端末から様々な端末まで）でのデータのやり取りを規定
  * データリング層のアドレス(MACなど)はローカルネットワーク内だけで有効
  * ネットワーク層で提供されるアドレスにより、ネットワーク超えた通信が可能に

#### トランスポート層(第４層)

* データ転送の制御を行う
  * ネットワーク層では通信の品質は保証されないため、それを補完する
    * 伝送エラーの検出、再送
    * ネットワーク全体のスループットを維持したりする機能を提供する
      * ネットワークに流すデータ量を調節する etc
  * ノード内で動作しているアプリケーションを特定する
    * そのための番号を`ポート番号`という

#### セッション層(第５層)

* 最終的な通信の目的に合わせてデータの送受信管理を行う
  * コネクション確立やデータ転送のタイミング管理を行い通信特性の差異を吸収
    * チャットのような対話型の通信、ダウンロードのような通信

#### プレゼンテーション層(第６層)

* データの表現形式を管理する
  * データの形式がわからないと、伝送されたデータを利用できない
    * 送受信されたデータが圧縮されているのか
    * 文字コードは何が使われているのか

* データ送信の部分と切り離して定義する
  * 新しいデータ形式が表れても、通信機器に影響を及ぼさずに対応できる


#### アプリケーション層(第７層)

* やり取りされたデータの意味内容を直接取り扱う
  * メールの規定：SMTP
  * Webアクセスの規定：HTTP
  * それぞれのアプリケーションに特価したプロトコルとなる
  * もっともユーザに近い部分を担当する

### パケット交換方式

* 二者間のデータ通信を行う方式の一つ
  * インターネット使われているやり方
  * ノードはデータをパケットに分割して送る
  * パケットを送る時しか回線を占有しない

* データをパケットと呼ばれる単位に区切り、一つ一つのパケットに宛先情報(ヘッダ)を添付して送信する

* パケット交換の実装の規定は`ITU-T勧告 X.25`として勧告されている
  * ITU：国際通信連合
    * 国際連合により設立された電気通信の規格の標準化を行う組織
  * ITU-Tはその下部組織
    * 通信に関する標準化を担当する
    * ここで作成された勧告がITU-T勧告(Vシリーズ、Xシリーズ等としてリリースされる)

``` ITU-T勧告 X.25

パケット   通信プロトコル
形態端末
            X.25
L3 |<-------------->| パケット
   |        HDLC    | 交換機
L2 |<-------------->|
   |        X.21    |
L1 |<-------------->|
                    パケット交換網
```

#### パケット交換方式の特徴

* 耐障害性
  * パケット通信では通信路を固定しない
    * 通信路に障害が発生した場合でも迂回経路をとることが可能
    * すべての回線路が利用不能になっても通信内容は失われない
      * 通信内容がパケット交換機に蓄積されているため

* パケット多重
  * 回線の利用率が向上する
    * 一本の回線に別のノードあてのパケットを割り込ませることができるため

* 異機種間接続性
  * パケット交換機が色々な回線速度や通信プロトコルをサポートしていれば可能
    * エンドtoエンドのノード同士が同じ技術で構成されていなくてもよい

#### 用語

* 回線交換方式
  * 電話などで使われる通信の方式
  * 二者間で回線を確保したまま行う通信方式

* ペイロード
  * パケットのうち、ヘッダを除いたデータ部分のこと

* HDLC(High-level Data Link Control procedure)
  * 通信プロトコルのこと
  * データリンク層に分類される
  * 効率性・信頼性が向上している
  * とりあえずあんまり覚えてもしょうがない

* 分割されたデータの呼び方は各層で異なるが、厳密に決まりがあるわけではない
  * データリンク層
    * フレーム
  * ネットワーク層
    * パケット
  * トランスポート層
    * セグメント

### コネクション型通信とコネクションレス型通信

* ノード間のコネクション(接続)確立の方式には、コネクション型とコネクションレス型がある

#### コネクション型通信

* 送信ノードと受信ノードの間に伝送路が固定される通信方式

* 安定性の高い通信
  * 相手が有効な状態で機能しており、伝送データも届く状態にあるかを確認してから送受信を開始するため

* 通信にかかわるオーバーヘッドは増加
  * コネクションを確立するための確認手順などを踏まなければデータ伝送ができないため

* オーバーヘッド
  * 余計な処理が発生(処理) > 時間がかかる(処理時間) > 負担になる(負荷)

#### コネクションレス型通信

* 相手ノードの確認や伝送路の確保を行わずに、すぐにデータを伝送し始める通信方式

* 通信手順を大幅に省略することができる
  * 余分な処理を行わずにいきなりデータ転送を開始
  * リアルタイム通信等に向いている
  * 通信機器にかかる負荷も減少させることが可能

* 通信の確実な伝達は保証されない

## 2. TCP/IP

### IPとTCP/IPプロトコルスイート

* IP
  * OSI参照モデルのネットワーク層における通信プロトコル
  * インターネット通信用に特化
  * そのため単独で利用されることは少ない
    * TCPなど、他のプロトコルと組み合わせて機能を形成する

* TCP/IPプロトコルスイート
  * = インターネットプロトコルスイート
  * IPと整合性が高い、或いはIPを下位プロトコルとして使用することを前提とする
  * IPv4(現在主流) > IPv6
  * 独自のネットワーク階層モデルを持つ
    * ４階層で構成
    * 設計思想に起因する
      * あまり細分化された階層モデルは実業においてかえって実装しにくい
    * IPはインターネット層であり、ネットワークIF層には依存しない
      * 任意の物理層、データリング層技術で構成できる
      * 使用例：イーサネット

|OSI参照モデル|TCP/IPプロトコルスイート|実装例|
|:--|:--|:--|:--|
|アプリケーション層|アプリケーション層|HTTP, SMTP, POP|
|プレゼンテーション層||FTP, DHCP, Telnet|
|セッション層||DNS, SNMP|
|トランスポート層|トランスポート層|TCP,UDP|
|ネットワーク層|インターネット層||
|データリング層|ネットワークインターフェース層|イーサネット|
|物理層|||

* イーサネット(Ethernet)
  * MACアドレスでアドレス管理を行う
  * 通信制御にCSMA/CDを用いる伝送方式
  * 物理層として10BASE-T等を利用する
  * イーサネット規格
    * {伝送速度}{伝送形式}{数字：ケーブル最大長、アルファベット：ケーブルの種類}
      * 伝送速度：Mbps
      * 伝送形式：BASEBAND, BROADBAND方式 etc
      * ケーブル最大長：100m単位
      * ケーブル種類：T > UTPケーブル、F > 光ファイバーケーブル
    * <http://www.n-study.com/network/ethernet.htm>

* CSMA/CD (Carrier Sense Multiple Access with Collision Detection)
  * イーサネットで使用される、通信の衝突を防ぐ技術
  * 早い者勝ちの媒体アクセス制御方式といわれる
  * CS(搬送波検知)
    * NICはデータを送信する前に、ケーブル上にすでにデータが流れているかどうかをチェック
    * 流れていれば、終わるまで待つ
    * 搬送波：信号を運搬する電波
  * MA(多重アクセス)
  * CD(衝突検知)
    * 検知はNICで行われる(通常の範囲外の電圧になる)
    * 検出後、送信元のコンピュータはデータ送信を中断して、それぞれランダムな時間待機
    * 待機後CSを行い再送
  * <http://www.n-study.com/network/csmacd.htm>

#### IPの特徴

* IP(Internet Protocol)
  * コネクションレス型通信を提供するインターネットワーキングプロトコル
    * パケット通信技術である
    * ベストエフォート型のコネクションレス型通信
    * 経路制御を行う

* IPでは通信品質を確保しない
  * 他のプロトコルと組み合わせることで、拡張機能を利用できるようにしている

* ベストエフォート
  * 通信を宛先に届けるために最大限の努力はするが、最終的な通信品質を保証しないことを指す
  * コスト的に大きなアドバンテージあり

#### IPヘッダ

* パケット通信では、パケットの先頭にパケット自体に関する情報が付加される
  * 送信元/先、パケットの大きさなど
  * TCP/IPでは、各層ごとにこのヘッダ情報がデータに付加され次の層へ渡される
  * IPで取り扱われるパケット = IPパケット

|ヘッダ|ヘッダ|ヘッダ||レイヤ|
|:--|:--|:--|:--|:--|
|   |   |  |メールなどのデータ|アプリケーション層|
|   |  |TCP|メールなどのデータ|トランスポート層|
|   |IP|TCP|メールなどのデータ|ネットワーク層|
|MAC|IP|TCP|メールなどのデータ|データリング層|

#### IPヘッダの構成

![IPヘッダ](./img/ipheader.png)