# ネットワーク

## 1. ネットワークの基礎

### プロトコル

* プロトコル
  * 通信を行う際に、事前に取り決めるルール
  * 例:日常会話
    * 媒体：空気
    * データリンク：音声
    * プレゼンテーション：日本語

* 通信における最重要概念

* 通信
  * データの送受信を行うこと

### OSI(Open System Interconnection)基本参照モデル

* OSI(基本)参照モデル
  * ISOが作ったデータ通信機能におけるモデル
  * 制定された目的
    * `異なる設計思想や世代のシステムと円滑に通信を行うこと`
  * プロトコルを標準化するにあたりどう作成すればよいのかガイドラインを示す
  * プロトコルの階層化を強く推奨している
    * メリット2つ
      * シンプルである
        * 通信プロトコルをシンプルにまとめることができる
        * １つの機能を小さく絞り込むことで安定した通信プログラムを開発できる
          * プロトコルスイート(プロトコルスタック)
          　* 目的の通信をするために必要な通信プロトコルをひと纏めにしたもの
      * 交換が容易である
        * プロトコルが更新された箇所だけを交換することが可能

* オープンシステム
  * どんな機器をつかっても仕様に沿っていれば接続できるようになっている仕組みのこと

* 7階層モデルと対応機器の例
  * 通信全体の機能を7分割している
  * 1-4を下位層、5-7を上位層
    * 下位層は通信そのものを制御する
    * 上位層は通信でやり取りされるデータの形などを規定する

|||対応機種|補足|
|:--|:--|:--|:--|:--|
|第7層(Layer7:L7)|アプリケーション層|ゲートウェイ|アプリケーションの世界|
|第6層(Layer6:L6)|プレゼンテーション層|||
|第5層(Layer5:L5)|セッション層|||
|第4層(Layer4:L4)|トランスポート層||トランスポートの世界(TCP/UDP)|
|第3層(Layer3:L3)|ネットワーク層|ルータ、L3スイッチ|IPパケットの世界(IP)|
|第2層(Layer2:L2)|データリンク層|ブリッジ、スイッチングハブ|イーサネットのフレームの世界(MAC), 宛先のみで、IPアドレスや中身を気にしない|
|第1層(Layer1:L1)|物理層|リピータ、ハブ|光、電流(信号)|

* 仮に下位層から上位層まで１つのプロトコルで開発された場合
  * プロトコルが更新されると、それに合わせてシステムのすべての箇所を変更する必要が生じる

### OSI参照モデルの詳細

#### 物理層(第１層)

* システムの物理的、電気的な性質を規定
  * デジタルデータをどのように電流の波形、電圧的な高低に割り付けるのか
  * ケーブルが満たすべき抵抗
  * コネクタピンの形状
  * etc

#### データリンク層(第２層)

* `同じネットワーク`に接続された隣接ノード間での通信について規定

* ブロードキャスト
  * 同じネットワークで接続されているすべてのノードにデータを送達する
  * その範囲を`ブロードキャストドメイン`と呼ぶ
  * MACアドレスの管理も行う

``` cmd
IPアドレスで到達できる範囲
<----------------------------------------------->
[PC]--同じネットワーク--[PC]--同じネットワーク--[PC]
<---------------------->|<---------------------->
MACで到達できる範囲
```

#### ネットワーク層(第３層)

* エンドtoエンド（ある端末から様々な端末まで）でのデータのやり取りを規定
  * データリング層のアドレス(MACなど)はローカルネットワーク内だけで有効
  * ネットワーク層で提供されるアドレスにより、ネットワーク超えた通信が可能に

#### トランスポート層(第４層)

* データ転送の制御を行う
  * ネットワーク層では通信の品質は保証されないため、それを補完する
    * 伝送エラーの検出、再送
    * ネットワーク全体のスループットを維持したりする機能を提供する
      * ネットワークに流すデータ量を調節する etc
  * ノード内で動作しているアプリケーションを特定する
    * そのための番号を`ポート番号`という

#### セッション層(第５層)

* 最終的な通信の目的に合わせてデータの送受信管理を行う
  * コネクション確立やデータ転送のタイミング管理を行い通信特性の差異を吸収
    * チャットのような対話型の通信、ダウンロードのような通信

#### プレゼンテーション層(第６層)

* データの表現形式を管理する
  * データの形式がわからないと、伝送されたデータを利用できない
    * 送受信されたデータが圧縮されているのか
    * 文字コードは何が使われているのか

* データ送信の部分と切り離して定義する
  * 新しいデータ形式が表れても、通信機器に影響を及ぼさずに対応できる


#### アプリケーション層(第７層)

* やり取りされたデータの意味内容を直接取り扱う
  * メールの規定：SMTP
  * Webアクセスの規定：HTTP
  * それぞれのアプリケーションに特価したプロトコルとなる
  * もっともユーザに近い部分を担当する

### パケット交換方式

* 二者間のデータ通信を行う方式の一つ
  * インターネット使われているやり方
  * ノードはデータをパケットに分割して送る
  * パケットを送る時しか回線を占有しない

* データをパケットと呼ばれる単位に区切り、一つ一つのパケットに宛先情報(ヘッダ)を添付して送信する

* パケット交換の実装の規定は`ITU-T勧告 X.25`として勧告されている
  * ITU：国際通信連合
    * 国際連合により設立された電気通信の規格の標準化を行う組織
  * ITU-Tはその下部組織
    * 通信に関する標準化を担当する
    * ここで作成された勧告がITU-T勧告(Vシリーズ、Xシリーズ等としてリリースされる)

``` ITU-T勧告 X.25

パケット   通信プロトコル
形態端末
            X.25
L3 |<-------------->| パケット
   |        HDLC    | 交換機
L2 |<-------------->|
   |        X.21    |
L1 |<-------------->|
                    パケット交換網
```

#### パケット交換方式の特徴

* 耐障害性
  * パケット通信では通信路を固定しない
    * 通信路に障害が発生した場合でも迂回経路をとることが可能
    * すべての回線路が利用不能になっても通信内容は失われない
      * 通信内容がパケット交換機に蓄積されているため

* パケット多重
  * 回線の利用率が向上する
    * 一本の回線に別のノードあてのパケットを割り込ませることができるため

* 異機種間接続性
  * パケット交換機が色々な回線速度や通信プロトコルをサポートしていれば可能
    * エンドtoエンドのノード同士が同じ技術で構成されていなくてもよい

#### 用語

* 回線交換方式
  * 電話などで使われる通信の方式
  * 二者間で回線を確保したまま行う通信方式

* ペイロード
  * パケットのうち、ヘッダを除いたデータ部分のこと

* HDLC(High-level Data Link Control procedure)
  * 通信プロトコルのこと
  * データリンク層に分類される
  * 効率性・信頼性が向上している
  * とりあえずあんまり覚えてもしょうがない

* 分割されたデータの呼び方は各層で異なるが、厳密に決まりがあるわけではない
  * データリンク層
    * フレーム
  * ネットワーク層
    * パケット
  * トランスポート層
    * セグメント

### コネクション型通信とコネクションレス型通信

* ノード間のコネクション(接続)確立の方式には、コネクション型とコネクションレス型がある

#### コネクション型通信

* 送信ノードと受信ノードの間に伝送路が固定される通信方式

* 安定性の高い通信
  * 相手が有効な状態で機能しており、伝送データも届く状態にあるかを確認してから送受信を開始するため

* 通信にかかわるオーバーヘッドは増加
  * コネクションを確立するための確認手順などを踏まなければデータ伝送ができないため

* オーバーヘッド
  * 余計な処理が発生(処理) > 時間がかかる(処理時間) > 負担になる(負荷)

#### コネクションレス型通信

* 相手ノードの確認や伝送路の確保を行わずに、すぐにデータを伝送し始める通信方式

* 通信手順を大幅に省略することができる
  * 余分な処理を行わずにいきなりデータ転送を開始
  * リアルタイム通信等に向いている
  * 通信機器にかかる負荷も減少させることが可能

* 通信の確実な伝達は保証されない

## 2. TCP/IP

### IPとTCP/IPプロトコルスイート

* IP
  * OSI参照モデルのネットワーク層における通信プロトコル
  * インターネット通信用に特化
  * そのため単独で利用されることは少ない
    * TCPなど、他のプロトコルと組み合わせて機能を形成する

* TCP/IPプロトコルスイート
  * = インターネットプロトコルスイート
  * IPと整合性が高い、或いはIPを下位プロトコルとして使用することを前提とする
  * IPv4(現在主流) > IPv6
  * 独自のネットワーク階層モデルを持つ
    * ４階層で構成
    * 設計思想に起因する
      * あまり細分化された階層モデルは実業においてかえって実装しにくい
    * IPはインターネット層であり、ネットワークIF層には依存しない
      * 任意の物理層、データリング層技術で構成できる
      * 使用例：イーサネット

|OSI参照モデル|TCP/IPプロトコルスイート|実装例|
|:--|:--|:--|:--|
|アプリケーション層|アプリケーション層|HTTP, SMTP, POP|
|プレゼンテーション層||FTP, DHCP, Telnet|
|セッション層||DNS, SNMP|
|トランスポート層|トランスポート層|TCP,UDP|
|ネットワーク層|インターネット層||
|データリング層|ネットワークインターフェース層|イーサネット|
|物理層|||

* イーサネット(Ethernet)
  * MACアドレスでアドレス管理を行う
  * 通信制御にCSMA/CDを用いる伝送方式
  * 物理層として10BASE-T等を利用する
  * イーサネット規格
    * {伝送速度}{伝送形式}{数字：ケーブル最大長、アルファベット：ケーブルの種類}
      * 伝送速度：Mbps
      * 伝送形式：BASEBAND, BROADBAND方式 etc
      * ケーブル最大長：100m単位
      * ケーブル種類：T > UTPケーブル、F > 光ファイバーケーブル
    * <http://www.n-study.com/network/ethernet.htm>

* CSMA/CD (Carrier Sense Multiple Access with Collision Detection)
  * イーサネットで使用される、通信の衝突を防ぐ技術
  * 早い者勝ちの媒体アクセス制御方式といわれる
  * CS(搬送波検知)
    * NICはデータを送信する前に、ケーブル上にすでにデータが流れているかどうかをチェック
    * 流れていれば、終わるまで待つ
    * 搬送波：信号を運搬する電波
  * MA(多重アクセス)
  * CD(衝突検知)
    * 検知はNICで行われる(通常の範囲外の電圧になる)
    * 検出後、送信元のコンピュータはデータ送信を中断して、それぞれランダムな時間待機
    * 待機後CSを行い再送
  * <http://www.n-study.com/network/csmacd.htm>

#### IPの特徴

* IP(Internet Protocol)
  * コネクションレス型通信を提供するインターネットワーキングプロトコル
    * パケット通信技術である
    * ベストエフォート型のコネクションレス型通信
    * 経路制御を行う

* IPでは通信品質を確保しない
  * 他のプロトコルと組み合わせることで、拡張機能を利用できるようにしている

* ベストエフォート
  * 通信を宛先に届けるために最大限の努力はするが、最終的な通信品質を保証しないことを指す
  * コスト的に大きなアドバンテージあり

#### IPヘッダ

* パケット通信では、パケットの先頭にパケット自体に関する情報が付加される
  * 送信元/先、パケットの大きさなど
  * TCP/IPでは、各層ごとにこのヘッダ情報がデータに付加され次の層へ渡される
  * IPで取り扱われるパケット = IPパケット

|ヘッダ|ヘッダ|ヘッダ||レイヤ|
|:--|:--|:--|:--|:--|
|   |   |  |メールなどのデータ|アプリケーション層|
|   |  |TCP|メールなどのデータ|トランスポート層|
|   |IP|TCP|メールなどのデータ|ネットワーク層|
|MAC|IP|TCP|メールなどのデータ|データリング層|

#### IPヘッダの構成

![IPヘッダ](./img/ipheader.png)

### IPバージョン６(IPv6)

* IPアドレスの枯渇問題に対応するための本命技術
  * IPアドレス空間の拡張
  * IPsecの実装
  * etc

* アドレス空間の拡張
  * IPv4の４倍である128bitに拡張
    * 2の128乗 = 43億の4乗（天文学的な数字）

* 表記方法
  * アドレス空間を16新数で表記する
  * :0000:が連続する箇所は短縮してよい
    * ただし１か所だけ
  * 先頭から連続する0は省略可能
    * ただし::の中に必ず１つは数値が入っている必要あり

``` ipv6
FFFF:0000:FFFF:0000:0000:0000:0000:FFFF

FFFF:0000:FFFF::FFFF

FFFF:0:FFFF::FFFF
```

### TCP(Transmission Control Protocol)

* トランスポート層のプロトコル
* IPが通信の完全性を保証しない
* その補完をするために以下の機能を追加している
  * 送達管理
  * 伝送管理

#### コネクションの確立

* 通信に先立ってコネクションの確立を行うコネクション型通信を提供する
  * IPは`コネクションレス型通信`
  * 確立のために`３ウェイハンドシェイク`を行う
    * コネクション確立要求パケット：SYN
    * 確認応答パケット：ACK
    * ACKとSYNのやり取りを３回行うことから命名された
  * コネクション切断時にもハンドシェイクを行う
    * 確立と切断を完全に管理する

``` 3way handshake

                1. SYN
        |------------------------>|
        |   2. 1-ACK and SYN      |
Client  |<------------------------|  Server
        |       3. 2-ACK          |
        |------------------------>|

```

#### TCPヘッダ

* TCPはフロー制御も行うため、ヘッダがもつ情報は複雑
  * 注意すべきフィールドは`シーケンス番号`と`ACK番号`

* シーケンス番号
  * 送信するセグメントのデータ全体での位置をオクテット(8bit)単位で表す
  * 分割したパケットを元の順序通りに受信側で組みなおすことができる

* ACK番号
  * セグメントデータを受信した際のACK応答時に利用される番号
  * 次に受信すべきシーケンス番号が挿入される

* クラッカーが不正アクセスを行うために使うパケットは、シーケンス番号やACK番号の整合性が取れていない場合が多い
  * フィールドの内容を確認することによって不正パケットを検出する

![TCPヘッダ](./img/tcpheader.png)

### UDP(User Datagram Protocol)

* トランスポート層のプロトコル
  * L4の本来の目的である`送達管理を行わない`
    * 送達性の保証は提供しないが、通信手順・ヘッダ構造がシンプル
    * トラブルが起こらない限りオーバーヘッドの少ない通信環境を提供する
  * アプリケーションの識別管理のみを提供する

* 以下のケースで用いられる
  * 通信速度が非常に重要なシステムで伝送路の品質が保証されている
  * リアルタイム性が重要な動画などのストリーミング配信
  * ブロードキャスト通信

* TCP, UDPの長所と短所
  * <http://itpro.nikkeibp.co.jp/article/lecture/20070305/263897/>

||長所|短所|
|:--|:--|:--|
|TCP|信頼性が高い|複雑で処理が重い、通信機器への負担|
|UDP|通信速度が速い、シンプル|信頼性が低い(送達性の保証をしない)|

#### UDPヘッダ

* ヘッダ構造はシンプル

![UDPヘッダ](./img/udpheader.png)

### トランスポート層のプロトコルとポート番号

* ヘッダに送信先ポート番号と送信元ポート番号を付与する
  * 送信先ポート番号：通信の相手先を特定するための番号
  * 送信元ポート番号：送信元の識別のための番号
  * 通信を受けた送信先からは、このヘッダの「送信元ポート番号」へ向けて通信が返される

## 3. IPアドレス

### IPアドレス

* インターネット上のノードを一意に特定するためのアドレス

* 重複は許されない

* IPv4では32bitで表現する
  * 人が見やすいように8bitごと(`1オクテット`)に区切って10進数化
  * 約43億台のノードを識別可能

### ネットワークアドレスとホストアドレス

* IPアドレスはネットワークアドレス部とホストアドレス部にわかれる
  * その境界を決めるのが`サブネットマスク`

* サブネットマスク
  * IPアドレスと同じように32bitであらわされる情報
  * 1で表される部分が`ネットワークアドレス部`
  * 0で表される部分が`ホストアドレス部`
  * `クラスレスサブネットマスク`
    * １オクテットの途中に境目が存在する場合
    * １０進数表記した場合、255と0以外の値をとることになる
  * 表記方法
    1. IPアドレスと別にそのまま記述
    1. CIDR(Classless Inter-Domain Routing, サイダー)表記
      * CIDRではサブネットマスクの値を好きに決められる
        * 同じネットワークとして扱うIPアドレスの個数を調整できる
        * IPアドレスを見てもサブネットマスクの値は分からない
          * サブネットマスクの値も一緒に伝える(サブネットマスクの１の個数)
          * 例）198.51.100.xxx`/24`

* IPアドレスとサブネットマスク

||10進数表記|2進数表記||
|:--|:--|:--|:--|
|サブネットマスク|255.255.0.0|11111111 11111111|00000000 00000000|
|||ネットワークアドレス部|ホストアドレス部|
|IPアドレス|192.168.0.1|11000000 10101000|00000000 00000001|
|ネットワークアドレス|192.168.0.0|11000000 10101000|00000000 00000000|
|ノードのIPアドレス|192.168.0.1|11000000 10101000|00000000 00000001|
|ブロードキャストアドレス|192.168.255.255|11000000 10101000|11111111 11111111|

#### ネットワークアドレス部

* ネットワークに対して付与される番号
  * 同じNWに所属するノードのネットワークアドレス部は同一である必要あり

* ルータはIPアドレスのネットワークアドレス部をみてIPパケットを転送する必要があるかを判断する

* ネットワークを分割することによって、トラフィックの管理を実現する

* `ブロードキャストアドレス`
  * ホストアドレス部がすべて`1`のアドレス
  * そのネットワーク内のすべてのノードあての通信を意味する

* `ネットワークアドレス`
  * ホストアドレス部がすべて`0`のアドレス
  * そのネットワークそのものを意味する
  * ノードを表すものではない

* IPマルチキャスト
  * マルチキャスト通信
    * あるグループに所属しているすべてのノードを宛先に指定して送信を行うための技術
    * ブロードキャスト通信とは異なりIGMPプロトコルを使うことで1:n通信を行う

#### ホストアドレス部

* 同じネットワークに参加しているノードを一意に判別するための番号

* ネットワークアドレス部とホストアドレス部の組み合わせにより、全体としてIPアドレスの一意性が保証される

#### IPアドレスクラス

* 初期のIPネットワークで採用されていた概念
* IPアドレスをその先頭アドレスによって`３つの種類`に分ける
  * サブネットマスク情報が不要
  * Class A: 大規模ネットワーク(ノード数：16777214個)
  * Class B: 中規模ネットワーク(ノード数：65534個)
  * Class C: 小規模ネットワーク(ノード数：254個[2^8-2])

``` ip adress class
        |--8bit--|--8bit--|--8bit--|--8bit--|
Class A |0      N|                          |
Class B |10              N|                 |
Class C |110                      N|        |
(N) .. ネットワークアドレス部
```

* ネットワークに配布するIPアドレス数が固定される
  * 実運用時にIPアドレスに余剰が出る(数を調整できない)
  * `クラスレスサブネットマスク`のほうがきめ細かいIPアドレス管理が可能

#### プライベートIPアドレス

* プライベートIPアドレス
  * 正規のIPアドレスの形をとる
  * IPプロトコルスタックを装備しているノードはそのまま利用することが可能
  * 異なるネットワークなら重複を許す
    * 実質的に利用できるIPアドレスの数を増やすことができる
  * 組織内で利用し、インターネット上に送出しない
  * 組織内では一意なアドレス
  * RFC(1918)で推奨されるクラスごとのプライベートIPアドレスは以下
    * クラスA: `10.0.0.0` - `10.255.255.255`
    * クラスB: `172.16.0.0` - `172.31.255.255`
    * クラスC: `192.168.0.0` - `192.168.255.255`
  * これに対し通常のIPアドレスを`グローバルIPアドレス`という

#### MACアドレス

* イーサネットやFDDIで使用されるNICに割り振られる`6byte`の情報
  * `IEEE`の管理下`必ず一意`に定まるよう製造段階で焼きこまれる
  * データリング接続を行うためのデータリンク層のアドレス
  * 同じネットワーク内で相手を識別するため

``` MAC
16進数

1byte
[12]-34-56-12-34-56
|-メーカ毎-|-製品毎-|
```