# 2. TCP/IP

## IPとTCP/IPプロトコルスイート

* IP
  * OSI参照モデルのネットワーク層における通信プロトコル
  * インターネット通信用に特化
  * そのため単独で利用されることは少ない
    * TCPなど、他のプロトコルと組み合わせて機能を形成する

* TCP/IPプロトコルスイート
  * = インターネットプロトコルスイート
  * IPと整合性が高い、或いはIPを下位プロトコルとして使用することを前提とする
  * IPv4(現在主流) > IPv6
  * 独自のネットワーク階層モデルを持つ
    * ４階層で構成
    * 設計思想に起因する
      * あまり細分化された階層モデルは実業においてかえって実装しにくい
    * IPはインターネット層であり、ネットワークIF層には依存しない
      * 任意の物理層、データリング層技術で構成できる
      * 使用例：イーサネット

|OSI参照モデル|TCP/IPプロトコルスイート|実装例|
|:--|:--|:--|:--|
|アプリケーション層|アプリケーション層|HTTP, SMTP, POP|
|プレゼンテーション層||FTP, DHCP, Telnet|
|セッション層||DNS, SNMP|
|トランスポート層|トランスポート層|TCP,UDP|
|ネットワーク層|インターネット層||
|データリング層|ネットワークインターフェース層|イーサネット|
|物理層|||

* イーサネット(Ethernet)
  * MACアドレスでアドレス管理を行う
  * 通信制御にCSMA/CDを用いる伝送方式
  * 物理層として10BASE-T等を利用する
  * イーサネット規格
    * {伝送速度}{伝送形式}{数字：ケーブル最大長、アルファベット：ケーブルの種類}
      * 伝送速度：Mbps
      * 伝送形式：BASEBAND, BROADBAND方式 etc
      * ケーブル最大長：100m単位
      * ケーブル種類：T > UTPケーブル、F > 光ファイバーケーブル
    * <http://www.n-study.com/network/ethernet.htm>

* CSMA/CD (Carrier Sense Multiple Access with Collision Detection)
  * イーサネットで使用される、通信の衝突を防ぐ技術
  * 早い者勝ちの媒体アクセス制御方式といわれる
  * CS(搬送波検知)
    * NICはデータを送信する前に、ケーブル上にすでにデータが流れているかどうかをチェック
    * 流れていれば、終わるまで待つ
    * 搬送波：信号を運搬する電波
  * MA(多重アクセス)
  * CD(衝突検知)
    * 検知はNICで行われる(通常の範囲外の電圧になる)
    * 検出後、送信元のコンピュータはデータ送信を中断して、それぞれランダムな時間待機
    * 待機後CSを行い再送
  * <http://www.n-study.com/network/csmacd.htm>

## IPの特徴

* IP(Internet Protocol)
  * コネクションレス型通信を提供するインターネットワーキングプロトコル
    * パケット通信技術である
    * ベストエフォート型のコネクションレス型通信
    * 経路制御を行う

* IPでは通信品質を確保しない
  * 他のプロトコルと組み合わせることで、拡張機能を利用できるようにしている

* ベストエフォート
  * 通信を宛先に届けるために最大限の努力はするが、最終的な通信品質を保証しないことを指す
  * コスト的に大きなアドバンテージあり

## IPヘッダ

* パケット通信では、パケットの先頭にパケット自体に関する情報が付加される
  * 送信元/先、パケットの大きさなど
  * TCP/IPでは、各層ごとにこのヘッダ情報がデータに付加され次の層へ渡される
  * IPで取り扱われるパケット = IPパケット

|ヘッダ|ヘッダ|ヘッダ||レイヤ|
|:--|:--|:--|:--|:--|
|   |   |  |メールなどのデータ|アプリケーション層|
|   |  |TCP|メールなどのデータ|トランスポート層|
|   |IP|TCP|メールなどのデータ|ネットワーク層|
|MAC|IP|TCP|メールなどのデータ|データリング層|

## IPヘッダの構成

![IPヘッダ](./img/ipheader.png)

## IPバージョン６(IPv6)

* IPアドレスの枯渇問題に対応するための本命技術
  * IPアドレス空間の拡張
  * IPsecの実装
  * etc

* アドレス空間の拡張
  * IPv4の４倍である128bitに拡張
    * 2の128乗 = 43億の4乗（天文学的な数字）

* 表記方法
  * アドレス空間を16新数で表記する
  * :0000:が連続する箇所は短縮してよい
    * ただし１か所だけ
  * 先頭から連続する0は省略可能
    * ただし::の中に必ず１つは数値が入っている必要あり

``` ipv6
FFFF:0000:FFFF:0000:0000:0000:0000:FFFF

FFFF:0000:FFFF::FFFF

FFFF:0:FFFF::FFFF
```

## TCP(Transmission Control Protocol)

* トランスポート層のプロトコル
* IPが通信の完全性を保証しない
* その補完をするために以下の機能を追加している
  * 送達管理
  * 伝送管理

## コネクションの確立

* 通信に先立ってコネクションの確立を行うコネクション型通信を提供する
  * IPは`コネクションレス型通信`
  * 確立のために`３ウェイハンドシェイク`を行う
    * コネクション確立要求パケット：SYN
    * 確認応答パケット：ACK
    * ACKとSYNのやり取りを３回行うことから命名された
  * コネクション切断時にもハンドシェイクを行う
    * 確立と切断を完全に管理する

``` 3way handshake

                1. SYN
        |------------------------>|
        |   2. 1-ACK and SYN      |
Client  |<------------------------|  Server
        |       3. 2-ACK          |
        |------------------------>|

```

* 参考
  * <http://itpro.nikkeibp.co.jp/article/COLUMN/20070703/276587/>
  * <http://itpro.nikkeibp.co.jp/article/COLUMN/20070703/276587/>

## TCPヘッダ

* TCPはフロー制御も行うため、ヘッダがもつ情報は複雑
  * 注意すべきフィールドは`シーケンス番号`と`ACK番号`

* シーケンス番号
  * 送信するセグメントのデータ全体での位置をオクテット(8bit)単位で表す
  * 分割したパケットを元の順序通りに受信側で組みなおすことができる

* ACK番号
  * セグメントデータを受信した際のACK応答時に利用される番号
  * 次に受信すべきシーケンス番号が挿入される

* クラッカーが不正アクセスを行うために使うパケットは、シーケンス番号やACK番号の整合性が取れていない場合が多い
  * フィールドの内容を確認することによって不正パケットを検出する

![TCPヘッダ](./img/tcpheader.png)

## UDP(User Datagram Protocol)

* トランスポート層のプロトコル
  * L4の本来の目的である`送達管理を行わない`
    * 送達性の保証は提供しないが、通信手順・ヘッダ構造がシンプル
    * トラブルが起こらない限りオーバーヘッドの少ない通信環境を提供する
  * アプリケーションの識別管理のみを提供する

* 以下のケースで用いられる
  * 通信速度が非常に重要なシステムで伝送路の品質が保証されている
  * リアルタイム性が重要な動画などのストリーミング配信
  * ブロードキャスト通信

* TCP, UDPの長所と短所
  * <http://itpro.nikkeibp.co.jp/article/lecture/20070305/263897/>

||長所|短所|
|:--|:--|:--|
|TCP|信頼性が高い|複雑で処理が重い、通信機器への負担|
|UDP|通信速度が速い、シンプル|信頼性が低い(送達性の保証をしない)|

## UDPヘッダ

* ヘッダ構造はシンプル

![UDPヘッダ](./img/udpheader.png)

## トランスポート層のプロトコルとポート番号

* ヘッダに送信先ポート番号と送信元ポート番号を付与する
  * 送信先ポート番号：通信の相手先を特定するための番号
  * 送信元ポート番号：送信元の識別のための番号
  * 通信を受けた送信先からは、このヘッダの「送信元ポート番号」へ向けて通信が返される
