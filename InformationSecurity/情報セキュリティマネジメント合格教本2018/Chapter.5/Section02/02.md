# 2. DBMS

## DBMS(Database Management System)

* データベースを作成し、適切に管理・運用するための様々な機能を持つ
  * 以下を特に重視する(データベースの生命線、脅かされると安心して利用できない)
    * データを壊さないこと
    * 矛盾を生じさせないこと

## 排他制御

* ロックをかけてデータを読み込む、更新したりできないようにする etc
  * 共有して利用するため必要

* ロックには二種類ある
  * 共有ロック(Shared lock)
    * データの更新はできないが、読み込むことは可能
  * 排他[専有]ロック(Exclusive lock)
    * データの更新も読み込みもできない

* ロックの粒度も工夫ができる
  * 表全体をロック
    * メリット：楽
    * デメリット：`更新、読み込みできない人がたくさん出てくる`
  * 一部分だけのロック
    * メリット：ロックによって迷惑する人が減る
    * デメリット：`DBMSの負担が大きくなる`

## データのリカバリ

* データの喪失を防ぐため、要所要所でバックアップがとられる
  * 加え、`ジャーナル`と呼ばれるログをとる
    * 故障などの際にデータベースを復元する努力がはらわれている
    * ジャーナル：<http://e-words.jp/w/%E3%82%B8%E3%83%A3%E3%83%BC%E3%83%8A%E3%83%AB.html>

* ロールフォワード(roll forward)
  * `物理的な障害`が発生した場合の対処法
    * データベースのHDDが壊れてしまった場合等
  * 処理を`復元`する操作
  * <http://www.it-shikaku.jp/top30.php?hidari=09-04-02.php>

  ``` roll forward
   Backup   Start           End(commit)   Trouble
  ---|--------|===transaction===|------------x---
              |                 |
              |write            |
              |   rollforward-->|
   [更新前ジャーナル]        [更新後ジャーナル] 

  1. 障害が発生したディスクを交換する
  2. データベースのBackupを使って開始前の時点に復元する
    リストア: リハーサルしておかないと、本番で大抵失敗する
  3. 「更新後ジャーナル」を使って同じ処理を実行し復元する
  ```

* ロールバック(roll back)
  * `論理的な障害`が発生した場合の対処法
    * 誤ってデータベース操作を行ってしまったような場合
  * 処理を`取り消し`する操作

  ``` roll back
            Start            Trouble
  ------------|===transaction===x\----------------
              |
              |write
              |<----rollback
   [更新前ジャーナル]

  1. 「更新前ジャーナル」を使って処理を巻き戻す
  ```

## トランザクション

* データベースでは...
  * 分割するとまずい、ひと塊の処理
  * 例）お金の振り込み
    * 自分の口座を減額する + 相手の口座を増額する は１セット
    * 減額が成功して増額が成功はまずい
    * 全部やり遂げるか、全部やらないかのどちらか(原子性)
  * 一連の処理全体を一個の処理単位として管理している
    * データベースにおけるデータの一貫性を保証するため

* ACID特性
  * 1970年代後半、ジム・グレイ(James Nicholas Gray)が定義した概念
  * トランザクションの特性を表す
    * 信頼性のあるトランザクションシステムの持つべき性質
    * ACID特性が遵守されている事がデータの一貫性を保証するため不可欠とされる
  * 原子性(Atomicity, 不可分性)
    * 一連の処理は、全体として実行されるか、実行されないかどちらかであることが保証される
  * 一貫性(Consistency)
    * 処理結果がある条件や整合性を保つことが保証される
  * 独立性(isolation)
    * その処理について、結果だけが他から見ることができる
    * 実行中の途中状態が他へ影響することがない
  * 永続性(durability, 耐久性)
    * 「その処理が完了した」という結果を受けた段階で、結果は失われることのない永続的なものとしてデータベースに記録されている